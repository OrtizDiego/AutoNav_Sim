services:
  ros_dev:
    build: .
    image: autonav_sim:latest
    container_name: autonav_dev
    # Networking: Host allows the container to use your PC's network (easier for ROS)
    network_mode: host
    ipc: host
    privileged: true
    environment:
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
      # --- ADDED: NVIDIA Environment Variables ---
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      # Force the container to look at the mounted WSL drivers
      - LD_LIBRARY_PATH=/usr/lib/wsl/lib:$LD_LIBRARY_PATH
      - MESA_D3D12_DEFAULT_ADAPTER_NAME=NVIDIA

    # --- ADDED: GPU Resource Reservation ---
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]

    volumes:
      # Sync your local 'src' folder with the container's 'src' folder
      - ./src:/root/dev_ws/src
      - /mnt/wslg/.X11-unix:/tmp/.X11-unix
      # --- ADDED: WSL Graphics Mounts ---
      # Required to pass the GUI socket and drivers from Windows to Docker
      - /mnt/wslg:/mnt/wslg
      - /usr/lib/wsl:/usr/lib/wsl

    command: sleep infinity
