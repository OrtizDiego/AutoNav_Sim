version: '3.8'

services:
  # 1. The Base Image (Common to everyone)
  autonav_base:
    image: autonav_sim:latest
    build: .
    network_mode: host
    ipc: host
    privileged: true
    environment:
      - DISPLAY=${DISPLAY:-:0}
      - QT_X11_NO_MITSHM=1
    volumes:
      - ./src:/root/dev_ws/src
      - /tmp/.X11-unix:/tmp/.X11-unix
      # Map the graphics socket if it exists (safe even if empty on some systems)
      - /mnt/wslg:/mnt/wslg

  # 2. CPU Mode (Default - works for everyone)
  cpu:
    extends: autonav_base
    container_name: autonav_cpu
    environment:
      - LIBGL_ALWAYS_SOFTWARE=1 # Forces software rendering if hardware fails
    command: sleep infinity

  # 3. GPU Mode (Only for NVIDIA users)
  gpu:
    extends: autonav_base
    container_name: autonav_gpu
    # Only Start this service if specifically asked
    profiles: [ "gpu" ]
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      - LD_LIBRARY_PATH=/usr/lib/wsl/lib:$LD_LIBRARY_PATH
      - MESA_D3D12_DEFAULT_ADAPTER_NAME=NVIDIA
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]
    volumes:
      - /usr/lib/wsl:/usr/lib/wsl
    command: sleep infinity
